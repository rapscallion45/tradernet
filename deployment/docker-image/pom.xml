<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.tradernet</groupId>
        <artifactId>tradernet</artifactId>
        <version>1.0.0</version>
        <relativePath>../../pom.xml</relativePath>
    </parent>

    <name>Docker Image</name>

    <artifactId>docker-image</artifactId>
    <packaging>pom</packaging>

    <properties>
        <docker.repo>tradernet</docker.repo>
        <docker.sub.repo>tradernet</docker.sub.repo>
        <docker.image.name>${docker.repo}/${docker.sub.repo}:${docker.image.tag}</docker.image.name>
        <docker.image.tag>${git.branch.docker}</docker.image.tag>
        <project.build.docker.dir>${project.build.outputDirectory}/docker-build</project.build.docker.dir>
        <postgresql.version>42.7.2</postgresql.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>web</artifactId>
            <version>${project.version}</version>
            <type>war</type>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>api</artifactId>
            <version>${project.version}</version>
            <type>war</type>
        </dependency>
    </dependencies>

    <profiles>
        <profile>
            <id>build-image</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-dependency-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>copy-dependencies</id>
                                <phase>generate-resources</phase>
                                <goals>
                                    <goal>copy</goal>
                                </goals>
                                <configuration>
                                    <outputDirectory>${project.build.docker.dir}</outputDirectory>
                                    <artifactItems>
                                        <artifactItem>
                                            <groupId>${project.groupId}</groupId>
                                            <artifactId>api</artifactId>
                                            <version>${project.version}</version>
                                            <type>war</type>
                                            <destFileName>tradernet.war</destFileName>
                                        </artifactItem>
                                        <artifactItem>
                                            <groupId>org.postgresql</groupId>
                                            <artifactId>postgresql</artifactId>
                                            <version>${postgresql.version}</version>
                                            <type>jar</type>
                                            <destFileName>postgresql.jar</destFileName>
                                        </artifactItem>
                                    </artifactItems>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>

                    <plugin>
                        <artifactId>maven-resources-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>copy-docker-sources</id>
                                <phase>generate-sources</phase>
                                <goals>
                                    <goal>copy-resources</goal>
                                </goals>
                                <configuration>
                                    <outputDirectory>${project.build.docker.dir}</outputDirectory>
                                    <overwrite>true</overwrite>
                                    <resources>
                                        <resource>
                                            <directory>src/main/docker</directory>
                                            <filtering>true</filtering>
                                        </resource>
                                        <resource>
                                            <directory>../wildfly-modules/src/main/resources</directory>
                                            <filtering>false</filtering>
                                        </resource>
                                    </resources>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>

                    <plugin>
                        <groupId>io.github.git-commit-id</groupId>
                        <artifactId>git-commit-id-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <goals>
                                    <goal>revision</goal>
                                </goals>
                            </execution>
                        </executions>
                        <configuration>
                            <skipPoms>false</skipPoms>
                            <replacementProperties>
                                <replacementProperty>
                                    <property>git.branch</property>
                                    <propertyOutputSuffix>docker</propertyOutputSuffix>
                                    <token>/</token>
                                    <value>-</value>
                                    <regex>false</regex>
                                    <transformationRules>
                                        <transformationRule>
                                            <apply>BEFORE</apply>
                                            <action>LOWER_CASE</action>
                                        </transformationRule>
                                    </transformationRules>
                                </replacementProperty>
                                <replacementProperty>
                                    <property>git.branch.docker</property>
                                    <token>([^a-z0-9-]+)</token>
                                    <value />
                                </replacementProperty>
                                <replacementProperty>
                                    <property>git.branch.docker</property>
                                    <token>^(.*)$</token>
                                    <value>branch-$1</value>
                                </replacementProperty>
                                <replacementProperty>
                                    <property>git.branch.docker</property>
                                    <regex>false</regex>
                                    <token>branch-master</token>
                                    <value>latest</value>
                                </replacementProperty>
                            </replacementProperties>
                        </configuration>
                    </plugin>

                    <plugin>
                        <groupId>io.fabric8</groupId>
                        <artifactId>docker-maven-plugin</artifactId>
                        <configuration>
                            <images>
                                <image>
                                    <name>${docker.image.name}</name>
                                    <build>
                                        <contextDir>${project.build.docker.dir}</contextDir>
                                    </build>
                                </image>
                            </images>
                        </configuration>
                        <executions>
                            <execution>
                                <id>build</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>build</goal>
                                </goals>
                            </execution>
                            <execution>
                                <id>start</id>
                                <phase>none</phase>
                            </execution>
                            <execution>
                                <id>stop</id>
                                <phase>none</phase>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>

        <profile>
            <id>run-test-container</id>
            <properties>
                <docker.image.tag>local-test</docker.image.tag>
                <test.container.name>tradernet-test</test.container.name>
                <test.container.port>8080</test.container.port>
                <test.container.admin.password>local-admin-password</test.container.admin.password>
                <test.container.db.type>POSTGRES</test.container.db.type>
                <test.container.db.host>postgres</test.container.db.host>
                <test.container.db.port>5432</test.container.db.port>
                <test.container.db.name>tradernet</test.container.db.name>
                <test.container.db.user>tradernet</test.container.db.user>
                <test.container.db.password>tradernet</test.container.db.password>
            </properties>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.codehaus.mojo</groupId>
                        <artifactId>exec-maven-plugin</artifactId>
                        <version>3.3.0</version>
                        <executions>
                            <execution>
                                <id>run-test-container</id>
                                <phase>verify</phase>
                                <goals>
                                    <goal>exec</goal>
                                </goals>
                                <configuration>
                                    <executable>docker</executable>
                                    <arguments>
                                        <argument>run</argument>
                                        <argument>--rm</argument>
                                        <argument>--name</argument>
                                        <argument>${test.container.name}</argument>
                                        <argument>-p</argument>
                                        <argument>${test.container.port}:8080</argument>
                                        <argument>-e</argument>
                                        <argument>ADMIN_PASSWORD=${test.container.admin.password}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_TYPE=${test.container.db.type}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_HOST=${test.container.db.host}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_PORT=${test.container.db.port}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_NAME=${test.container.db.name}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_USER=${test.container.db.user}</argument>
                                        <argument>-e</argument>
                                        <argument>DB_PASSWORD=${test.container.db.password}</argument>
                                        <argument>${docker.image.name}</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>

        <profile>
            <id>tag-release-image</id>
            <properties>
                <docker.image.tag>${git.closest.tag.name}</docker.image.tag>
            </properties>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.github.git-commit-id</groupId>
                        <artifactId>git-commit-id-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>validate-git-properties</id>
                                <goals>
                                    <goal>validateRevision</goal>
                                </goals>
                                <phase>prepare-package</phase>
                            </execution>
                        </executions>
                        <configuration>
                            <validationProperties>
                                <validationProperty>
                                    <name>Validating working copy is not dirty</name>
                                    <value>${git.dirty}</value>
                                    <shouldMatchTo>false</shouldMatchTo>
                                </validationProperty>
                                <validationProperty>
                                    <name>Validating current commit has a tag</name>
                                    <value>${git.closest.tag.commit.count}</value>
                                    <shouldMatchTo>0</shouldMatchTo>
                                </validationProperty>
                            </validationProperties>
                        </configuration>
                    </plugin>
                </plugins>
            </build>
        </profile>

        <profile>
            <id>push-image</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.fabric8</groupId>
                        <artifactId>docker-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>push-image</id>
                                <phase>deploy</phase>
                                <goals>
                                    <goal>push</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>
</project>
